{
  "$schema": "https://shoehorn.dev/schemas/workflow-v2.json",
  "version": "1.0.2",
  "metadata": {
    "name": "test-requires-approval",
    "displayName": "TEST: Requires Approval",
    "description": "Test mold that demonstrates approval workflow requirements for production changes",
    "author": "platform-team",
    "icon": "ğŸ”",
    "category": "testing",
    "tags": ["test", "approval", "production", "deployment"],
    "requiresApproval": true,
    "approvalMetadata": {
      "reason": "Production deployment requires security and platform team approval",
      "minimumApprovers": 2,
      "approverGroups": ["security-team", "platform-leads"]
    }
  },
  "actions": [
    {
      "action": "deployment.service.production",
      "label": "Deploy to Production",
      "description": "Deploy service to production environment (REQUIRES APPROVAL)",
      "primary": true
    },
    {
      "action": "deployment.service.staging",
      "label": "Deploy to Staging",
      "description": "Deploy service to staging environment (no approval required)",
      "primary": false
    },
    {
      "action": "deployment.service.preview",
      "label": "Preview Changes",
      "description": "Preview deployment without executing",
      "primary": false
    }
  ],
  "inputs": {
    "type": "object",
    "properties": {
      "serviceName": {
        "type": "string",
        "description": "Name of the service to deploy",
        "pattern": "^[a-z0-9-]+$",
        "minLength": 3,
        "maxLength": 64,
        "default": "my-service"
      },
      "environment": {
        "type": "string",
        "description": "Target deployment environment",
        "enum": ["dev", "staging", "prod"],
        "default": "staging"
      },
      "imageTag": {
        "type": "string",
        "description": "Docker image tag to deploy",
        "pattern": "^v[0-9]+\\.[0-9]+\\.[0-9]+$",
        "default": "v1.0.0"
      },
      "replicas": {
        "type": "number",
        "description": "Number of pod replicas",
        "minimum": 1,
        "maximum": 10,
        "default": 3
      },
      "enableMetrics": {
        "type": "boolean",
        "description": "Enable Prometheus metrics scraping",
        "default": true
      },
      "approver": {
        "type": "string",
        "description": "Select approver (tests catalog:users)",
        "ui:widget": "select",
        "ui:options": {
          "source": "catalog:users",
          "placeholder": "Select approver...",
          "helpText": "User who will approve this deployment"
        }
      },
      "justification": {
        "type": "string",
        "description": "Justification for this deployment",
        "ui:widget": "textarea",
        "ui:options": {
          "rows": 4,
          "placeholder": "Explain why this deployment is needed..."
        }
      }
    },
    "required": ["serviceName", "environment", "imageTag", "approver", "justification"]
  },
  "outputs": {
    "deploymentStatus": {
      "description": "Deployment status",
      "type": "string"
    },
    "approvalRequired": {
      "description": "Whether approval was required",
      "type": "boolean"
    },
    "approvalRequestId": {
      "description": "Approval request ID if created",
      "type": "string"
    }
  },
  "steps": [
    {
      "id": "validate_inputs",
      "name": "Step 1: Validate Deployment Inputs",
      "adapter": "shell",
      "config": {
        "command": "echo",
        "args": [
          "ğŸ” Validating deployment parameters...\n\nğŸ“¦ Service: {{.Inputs.serviceName}}\nğŸ·ï¸  Image Tag: {{.Inputs.imageTag}}\nğŸŒ Environment: {{.Inputs.environment | upper}}\nğŸ“Š Replicas: {{.Inputs.replicas}}\nğŸ“ˆ Metrics: {{if .Inputs.enableMetrics}}âœ… Enabled{{else}}âŒ Disabled{{end}}\n\n{{if eq .Inputs.environment \"prod\"}}âš ï¸  PRODUCTION DEPLOYMENT - APPROVAL REQUIRED{{else}}âœ… Non-production deployment - no approval needed{{end}}"
        ]
      }
    },
    {
      "id": "check_approval_policy",
      "name": "Step 2: Check Approval Policy",
      "adapter": "shell",
      "depends_on": ["validate_inputs"],
      "config": {
        "command": "echo",
        "args": [
          "ğŸ” Checking approval requirements...\n\n{{if eq .Inputs.environment \"prod\"}}ğŸ›‘ APPROVAL REQUIRED\n\nğŸ“‹ Approval Policy: Production Deployments\nğŸ‘¥ Required Approvers: 2\nğŸ·ï¸  Approver Groups:\n   - security-team\n   - platform-leads\n\nğŸ‘¤ Requested Approver: {{.Inputs.approver}}\nğŸ“ Justification: {{.Inputs.justification}}\n\nâ³ Waiting for approval...{{else}}âœ… No approval required for {{.Inputs.environment}} environment{{end}}"
        ]
      }
    },
    {
      "id": "simulate_deployment",
      "name": "Step 3: Simulate Deployment",
      "adapter": "shell",
      "depends_on": ["check_approval_policy"],
      "config": {
        "command": "echo",
        "args": [
          "ğŸš€ Simulating deployment...\n\n{{if eq .Inputs.environment \"prod\"}}ğŸ”’ [APPROVAL PENDING] Deployment would execute after approval{{else}}âœ… Deploying {{.Inputs.serviceName}}:{{.Inputs.imageTag}} to {{.Inputs.environment}}\n\nğŸ“¦ Creating {{.Inputs.replicas}} replicas...\n{{if .Inputs.enableMetrics}}ğŸ“Š Configuring Prometheus metrics...{{end}}\nâœ… Deployment successful!{{end}}"
        ]
      }
    },
    {
      "id": "final_status",
      "name": "Step 4: Deployment Status Summary",
      "adapter": "shell",
      "depends_on": ["simulate_deployment"],
      "config": {
        "command": "echo",
        "args": [
          "ğŸ“Š DEPLOYMENT STATUS SUMMARY\n\n{{if eq .Inputs.environment \"prod\"}}ğŸ” Status: PENDING APPROVAL\n\nâ³ This deployment requires approval from:\n   â€¢ Security Team (1 approver)\n   â€¢ Platform Leads (1 approver)\n\nğŸ“§ Approval request sent to: {{.Inputs.approver}}\nğŸ“ Justification: {{.Inputs.justification}}\n\nğŸ”” You will be notified when:\n   âœ“ Approvers review your request\n   âœ“ All required approvals are received\n   âœ“ Deployment executes automatically\n\nâš™ï¸  To check approval status:\n   Use the Approval Requests dashboard\n\nâš ï¸  NOTE: This is a TEST mold demonstrating approval workflows.\n   Actual approval enforcement will be implemented in Tier 1-2.{{else}}âœ… Status: COMPLETED\n\nğŸš€ Deployment successful!\n   Service: {{.Inputs.serviceName}}\n   Version: {{.Inputs.imageTag}}\n   Environment: {{.Inputs.environment | upper}}\n   Replicas: {{.Inputs.replicas}}\n\nğŸ‰ No approval required for non-production environments.{{end}}\n\nğŸ§ª TEST COMPLETE - Approval workflow demonstration finished!"
        ]
      }
    }
  ],
  "rollback": {
    "enabled": true,
    "steps": [
      {
        "id": "rollback_deployment",
        "name": "Rollback Deployment",
        "adapter": "shell",
        "config": {
          "command": "echo",
          "args": [
            "â®ï¸  Rolling back deployment for {{.Inputs.serviceName}}...\n\nğŸ”„ Reverting to previous version\nâœ… Rollback complete!"
          ]
        }
      }
    ]
  }
}
